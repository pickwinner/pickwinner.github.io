<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Comment Picker — Unique Winners</title>
<style>
:root{--bg:#1f85bf;--dark:#083b66;--card:#fff;--accent:#0a78c0}
html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);display:flex;justify-content:center;padding:20px;box-sizing:border-box;color:#fff}
.container{width:100%;max-width:760px}
.headerCard{background:linear-gradient(0deg,#1b77b3,#1e86c3);padding:16px;border-radius:14px;color:#fff;margin-bottom:18px;box-shadow:0 10px 30px rgba(0,0,0,0.18)}
.headerCard .title{font-weight:800;font-size:18px}
.card{background:var(--card);color:#0b2b3d;border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.12);margin-bottom:14px}
.inputFull{width:100%;padding:10px;border-radius:10px;border:1px solid #dbeaf6;font-size:15px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.bigBtn{background:var(--dark);color:#fff;padding:12px;border-radius:999px;border:none;font-weight:800;cursor:pointer}
.countPill{display:none;margin-top:12px;padding:10px 16px;border-radius:999px;background:var(--card);color:#0b2b3d;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,0.12);width:fit-content}
.stageCard{background:#f3f7fb;border-radius:14px;padding:22px;text-align:center;box-shadow:inset 0 8px 30px rgba(3,48,80,0.04)}
.avatar{width:110px;height:110px;border-radius:999px;border:6px solid var(--bg);overflow:hidden;margin:0 auto;background:#fff}
.avatar img{width:100%;height:100%;object-fit:cover}
.handle{font-weight:900;color:var(--bg);margin-top:10px}
.handle a{color:#0b66d6;text-decoration:none}
.commentBox{margin-top:10px;background:#fff;padding:10px;border-radius:10px;border:1px solid rgba(2,16,30,0.04);color:#174c60;min-height:44px}
.startCircle{width:140px;height:140px;border-radius:999px;border:10px solid var(--bg);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b2b3d;background:#fff;margin:18px auto 0;cursor:pointer;box-shadow:0 16px 30px rgba(0,0,0,0.12)}
.pickAgain{display:none;margin-top:12px;background:var(--dark);color:#fff;padding:10px;border-radius:10px;border:none;font-weight:900;cursor:pointer;width:100%}
.shareRow{display:none;margin-top:12px;gap:8px;justify-content:center;align-items:center}
.shareBtn{background:#0b7fb9;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.confettiWrap{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:9999}
.small{font-size:13px;color:#3b7ea1}
</style>
</head>
<body>
<div class="container">

  <div class="headerCard">
    <div class="title">YouTube Comment Picker — Unique Winners</div>
  </div>

  <div class="card">
    <input id="videoLink" class="inputFull" placeholder="https://youtu.be/..." />
    <div class="row">
      <label style="display:flex;align-items:center;gap:8px;font-weight:800;color:#0b2b3d"><input id="filterDup" type="checkbox" checked /> Filter duplicate & bot comments</label>
      <button id="loadBtn" class="bigBtn">LOAD UNIQUE COMMENTS <span id="spinner" style="display:none;margin-left:8px">⏳</span></button>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:800;color:#0b2b3d">Filter comments by words/hashtags (optional)</div>
      <input id="filterWords" class="inputFull" placeholder="e.g. giveaway,#win,subscribe" style="margin-top:8px" />
      <div class="small" style="margin-top:8px">Only comments containing ANY of these will be loaded.</div>
    </div>

    <div id="countPill" class="countPill"></div>
  </div>

  <div class="card stageCard" id="stage" style="display:none">
    <div class="avatar" id="avatarWrap" style="display:none"><img id="avatarImg" src=""></div>
    <div class="handle" id="handle">—</div>
    <div class="commentBox" id="commentBox"></div>

    <div id="startCircle" class="startCircle" role="button">START</div>

    <button id="pickAgain" class="pickAgain">PICK ANOTHER WINNER</button>

    <div class="shareRow" id="shareRow">
      <button id="shareBtn" class="shareBtn">Share winner</button>
      <div id="shareMsg" class="small"></div>
    </div>
  </div>

</div>

<div id="confetti" class="confettiWrap"></div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxyNB3zKYOQ1pAXAKZwxvcGvMaJ86oFtZjUiogO9GEzoAUk_TelM9WiZvZf9atjNTiLYg/exec";

let visibleComments = [];
let pickPool = [];
let usedThisSession = new Set();
let currentVideoId = "";
let animating = false;

/* ---------- Helper functions ---------- */
function extractVideoId(link){
  try{
    const u = new URL(link);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    if(u.hostname === 'youtu.be') return u.pathname.slice(1).split('?')[0];
    if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2];
  } catch(e){}
  return null;
}

/* ---------- DOM refs ---------- */
const videoLinkEl = document.getElementById('videoLink');
const loadBtn = document.getElementById('loadBtn');
const spinner = document.getElementById('spinner');
const countPill = document.getElementById('countPill');
const stage = document.getElementById('stage');
const avatarWrap = document.getElementById('avatarWrap');
const avatarImg = document.getElementById('avatarImg');
const handleEl = document.getElementById('handle');
const commentBox = document.getElementById('commentBox');
const startCircle = document.getElementById('startCircle');
const pickAgainBtn = document.getElementById('pickAgain');
const shareRow = document.getElementById('shareRow');
const shareBtn = document.getElementById('shareBtn');
const shareMsg = document.getElementById('shareMsg');
const filterDupEl = document.getElementById('filterDup');
const filterWordsEl = document.getElementById('filterWords');
const confettiWrap = document.getElementById('confetti');

/* ---------- Load comments ---------- */
loadBtn.addEventListener('click', async ()=>{
  const link = videoLinkEl.value.trim();
  const vid = extractVideoId(link);
  if(!vid){ alert('Invalid YouTube link'); return; }
  currentVideoId = vid;

  spinner.style.display = 'inline';
  countPill.style.display = 'inline-block';
  countPill.textContent = 'Counting…';

  usedThisSession = new Set();
  stage.style.display = 'none';
  avatarWrap.style.display = 'none';
  handleEl.textContent = '—';
  commentBox.textContent = '';
  pickAgainBtn.style.display = 'none';
  shareRow.style.display = 'none';
  shareMsg.textContent = '';

  const filterDup = filterDupEl.checked ? 'true' : 'false';
  const filterWords = (filterWordsEl.value || '').trim();

  try{
    const url = `${BACKEND_URL}?videoId=${vid}&filterDup=${filterDup}&filterWords=${encodeURIComponent(filterWords)}`;
    const res = await fetch(url);
    const data = await res.json();

    if(data.error){
      countPill.textContent = 'Error';
      spinner.style.display = 'none';
      return;
    }

    visibleComments = data.comments || [];
    pickPool = data.pickPool || [];

    const usedBack = new Set(data.usedWinners || []);
    if(usedBack.size){
      visibleComments = visibleComments.filter(c => !usedBack.has(c.channelId));
      usedBack.forEach(id => usedThisSession.add(id));
    }

    animateCountTo(data.uniqueUsers || visibleComments.length);

    stage.style.display = 'block';

  }catch(err){
    countPill.textContent = 'Error fetching';
  }finally{
    spinner.style.display = 'none';
  }
});

function animateCountTo(target){
  countPill.style.display = 'inline-block';
  let curr = 0;
  const steps = 40;
  const stepVal = Math.max(1, Math.floor(target/steps));
  const ms = 20;
  const t = setInterval(()=>{
    curr += stepVal;
    if(curr >= target) curr = target;
    countPill.innerHTML = `Amount of comments: <strong>${curr}</strong>`;
    if(curr >= target) clearInterval(t);
  }, ms);
}

/* ---------- Start shuffle ---------- */
startCircle.addEventListener('click', ()=>{
  if(animating) return;
  if(visibleComments.length === 0){ alert('No comments loaded'); return; }

  startCircle.style.display = 'none';
  pickAgainBtn.style.display = 'none';
  shareRow.style.display = 'none';

  animating = true;
  avatarWrap.style.display = 'block';
  handleEl.textContent = '';
  commentBox.textContent = '';

  let i=0;
  let steps=50;
  let delay=60;

  function run(){
    let c;
    let attempts=0;
    while(attempts < 8){
      c = visibleComments[Math.floor(Math.random()*visibleComments.length)];
      if(!c) break;
      const key = c.channelId || c.author.toLowerCase();
      if(!usedThisSession.has(key)) break;
      attempts++;
    }
    if(!c) c = visibleComments[Math.floor(Math.random()*visibleComments.length)];

    avatarImg.src = c.profileImageUrl;
    handleEl.textContent = '@' + c.author;
    commentBox.textContent = c.comment;

    i++;
    if(i < steps){
      if(i > steps*0.6) delay += 18;
      setTimeout(run, delay);
    }else{
      animating = false;
      finalPick();
    }
  }
  run();
});

/* ---------- Final winner ---------- */
async function finalPick(){
  try{
    await refreshPickPool();

    pickPool = pickPool.filter(p=>{
      const k = p.channelId || p.author.toLowerCase();
      return !usedThisSession.has(k);
    });

    if(pickPool.length === 0){
      const fallback = visibleComments.filter(c=>!usedThisSession.has(c.channelId));
      if(fallback.length===0){
        alert('No more unique users available');
        startCircle.style.display='block';
        return;
      }
      pickPool = fallback;
    }

    const final = pickPool[Math.floor(Math.random()*pickPool.length)];

    avatarImg.src = final.profileImageUrl;
    if(final.channelId){
      handleEl.innerHTML = `<a href="https://youtube.com/channel/${final.channelId}" target="_blank">@${final.author}</a>`;
    }else{
      handleEl.textContent = '@'+final.author;
    }
    commentBox.textContent = final.comment;

    const key = final.channelId || final.author.toLowerCase();
    usedThisSession.add(key);
    visibleComments = visibleComments.filter(c => (c.channelId||c.author.toLowerCase()) !== key);

    try{
      await fetch(BACKEND_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:"markWinner",videoId:currentVideoId,channelId:final.channelId||final.author})
      });
    }catch(e){}

    pickAgainBtn.style.display='block';
    shareRow.style.display='flex';
    launchConfetti();

    const shareUrl = window.location.origin + window.location.pathname + `?videoId=${encodeURIComponent(currentVideoId)}&winner=${encodeURIComponent(final.channelId||final.author)}`;
    shareBtn.onclick = ()=>{
      navigator.clipboard.writeText(shareUrl);
      shareMsg.textContent='Copied!';
      setTimeout(()=>shareMsg.textContent='',2000);
    };

  }catch(e){
    startCircle.style.display='block';
  }
}

/* ---------- Refresh pickPool ---------- */
async function refreshPickPool(){
  const filterDup = filterDupEl.checked ? 'true':'false';
  const filterWords = filterWordsEl.value || "";
  const url = `${BACKEND_URL}?videoId=${currentVideoId}&filterDup=${filterDup}&filterWords=${encodeURIComponent(filterWords)}`;
  const res = await fetch(url);
  const data = await res.json();
  pickPool = data.pickPool || [];

  pickPool = pickPool.filter(p=>{
    const k = p.channelId || p.author.toLowerCase();
    return !usedThisSession.has(k);
  });

  const usedBack = new Set(data.usedWinners||[]);
  visibleComments = visibleComments.filter(c=>!usedBack.has(c.channelId));
  usedBack.forEach(id=>usedThisSession.add(id));
}

/* ---------- Confetti ---------- */
function launchConfetti(){
  const colors=['#ffd66f','#ff9fa2','#9ef0b1','#9ed8ff','#d09eff','#ffd7a6'];
  for(let i=0;i<30;i++){
    const d=document.createElement('div');
    d.style.width=(6+Math.random()*8)+'px';
    d.style.height=(10+Math.random()*14)+'px';
    d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.position='absolute';
    d.style.left=(45+Math.random()*10)+'%';
    d.style.top='20%';
    d.style.borderRadius='2px';
    confettiWrap.appendChild(d);
    const dx=(Math.random()-0.5)*600;
    const dy=300+Math.random()*500;
    d.animate(
      [
        {transform:'translate(0,0) rotate(0deg)',opacity:1},
        {transform:`translate(${dx}px,${dy}px) rotate(${Math.random()*720}deg)`,opacity:0}
      ],
      {duration:900+Math.random()*900,easing:'cubic-bezier(.2,.8,.2,1)'}
    );
    setTimeout(()=>d.remove(),1500);
  }
}
</script>
</body>
</html>
