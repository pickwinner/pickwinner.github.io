<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Random Comment Picker</title>

<style>
    body{
        margin:0;
        font-family: Arial, sans-serif;
        background:#1ca0ff;
        padding:40px;
        color:#fff;
        text-align:center;
    }

    .box{
        background:#fff;
        width:85%;
        max-width:900px;
        margin:20px auto;
        padding:30px;
        border-radius:20px;
        box-shadow:0 8px 30px rgba(0,0,0,0.16);
        color:#000;
    }

    .inputField{
        width:95%;
        padding:15px;
        border-radius:50px;
        border:2px solid #007adf;
        font-size:17px;
        margin-top:12px;
    }

    .btn{
        background:#007adf;
        color:#fff;
        padding:14px 20px;
        border-radius:50px;
        border:none;
        width:70%;
        font-size:18px;
        margin-top:20px;
        cursor:pointer;
    }

    .winnerBox{
        background:#fff;
        width:85%;
        max-width:700px;
        padding:35px;
        margin:30px auto;
        border-radius:20px;
        box-shadow:0 8px 30px rgba(0,0,0,0.16);
        color:#000;
    }

    /* ------------ CIRCLE PROGRESS ANIMATION --------------- */

    .circleWrapper{
        position:relative;
        width:170px;
        height:170px;
        margin:0 auto;
    }

    .progressRing{
        position:absolute;
        top:0; left:0;
        width:170px;
        height:170px;
        transform:rotate(-90deg);
    }

    .progressRing circle{
        fill:none;
        stroke:#1ca0ff;
        stroke-width:12;
        stroke-linecap:round;
        stroke-dasharray:530;
        stroke-dashoffset:530;
    }

    .progressAnimate{
        animation:progressAnim 10s linear forwards;
    }

    @keyframes progressAnim{
        from{ stroke-dashoffset:530; }
        to{ stroke-dashoffset:0; }
    }

    .trophyIcon{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        font-size:70px;
        color:#f4c844;
    }

    .winnerPic{
        width:150px;
        height:150px;
        border-radius:50%;
        margin:0 auto;
        display:none;
        object-fit:cover;
        border:4px solid #1ca0ff;
    }

    .winnerName{
        margin-top:15px;
        font-size:26px;
        font-weight:bold;
        color:#007adf;
    }

    .winnerComment{
        margin-top:10px;
        font-size:18px;
        background:#eef7ff;
        padding:10px 18px;
        border-radius:12px;
        display:inline-block;
    }

</style>
</head>
<body>

<h1>YouTube Random Comment Picker</h1>
<h3>Giveaway Winner Picker</h3>

<div class="box">

    <label style="font-size:15px;font-weight:bold;">VIDEO LINK BELOW</label><br>
    <input id="videoLink" class="inputField" placeholder="Paste YouTube link here">

    <div style="text-align:left;margin-top:20px;margin-left:8%;">
        <label>
            <input type="checkbox" id="filterDup" checked>
            Filter duplicate & bot comments
        </label>
        <br><br>
        <label>
            <input type="checkbox" id="filterWord">
            Filter comments by a word / hashtag
        </label>
        <br>
        <input id="wordBox" class="inputField" style="display:none;margin-top:10px;" placeholder="Enter word / hashtag">
    </div>

    <button id="loadBtn" class="btn">GET TOTAL UNIQUE COMMENTS</button>

    <p id="countText" style="font-size:18px;font-weight:bold;margin-top:15px;display:none;">
        Amount of comments: <span id="countNum">0</span>
    </p>

</div>

<!-- WINNER AREA -->
<div id="winnerArea" class="winnerBox" style="display:none;">
    <p style="margin-top:-10px;font-size:15px;color:#555;">Click START to pick a winner</p>

    <div class="circleWrapper">
        <svg class="progressRing">
            <circle cx="85" cy="85" r="84"></circle>
        </svg>

        <div id="trophy" class="trophyIcon">üèÜ</div>
        <img id="winnerPic" class="winnerPic">
    </div>

    <div id="name" class="winnerName"></div>
    <div id="comment" class="winnerComment"></div>

    <button id="startBtn" class="btn" style="margin-top:25px;">START</button>
    <button id="newBtn" class="btn" style="margin-top:25px;display:none;">PICK ANOTHER WINNER</button>
</div>

<script>
/* --------------------------------------------------
    Comment Loading + Filtering
-------------------------------------------------- */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzS2QT2vSJ_RoXiQACij7iUWcmcJqFBHEelNrC7h1-XfRcdOx1gdQ1ZvJQuNruRRXM9xA/exec";

let comments = [];
let usedWinners = [];
let raffleInterval = null;
let raffleRunning = false;

document.getElementById("filterWord").onchange = function(){
    document.getElementById("wordBox").style.display = this.checked ? "block" : "none";
};

/* ------------------- LOAD COMMENTS ------------------- */
document.getElementById("loadBtn").onclick = async () => {
    let link = document.getElementById("videoLink").value.trim();
    let filterDup = document.getElementById("filterDup").checked;
    let filterWord = document.getElementById("filterWord").checked;
    let word = document.getElementById("wordBox").value.trim().toLowerCase();

    if(!link){ alert("Enter YouTube link"); return; }

    document.getElementById("loadBtn").innerText = "Loading...";
    document.getElementById("countText").style.display = "none";

    let videoId;
    try{
        const u = new URL(link);
        videoId = u.searchParams.get("v") || (u.hostname==="youtu.be" ? u.pathname.slice(1) : null);
    }catch(e){}

    if(!videoId){ alert("Invalid URL"); return; }

    const res = await fetch(`${BACKEND_URL}?videoId=${videoId}`);
    const data = await res.json();

    comments = data.pool || [];

    if(filterWord){
        comments = comments.filter(c => c.comment.toLowerCase().includes(word));
    }
    if(filterDup){
        let map = new Map();
        comments.forEach(c => { if(!map.has(c.author)) map.set(c.author, c); });
        comments = [...map.values()];
    }

    document.getElementById("countNum").innerText = comments.length;
    document.getElementById("countText").style.display = "block";
    document.getElementById("winnerArea").style.display = "block";
    document.getElementById("loadBtn").innerText = "GET TOTAL UNIQUE COMMENTS";
};

/* --------------------------------------------------
    RAFFLE ENGINE
-------------------------------------------------- */

function startCircleAnimation(){
    const circle = document.querySelector(".progressRing circle");
    circle.classList.remove("progressAnimate");
    void circle.offsetWidth;
    circle.classList.add("progressAnimate");
}

function startRaffle(){
    if(raffleRunning) return;
    raffleRunning = true;

    usedWinners = usedWinners || [];

    document.getElementById("winnerPic").style.display = "none";
    document.getElementById("trophy").style.display = "block";
    document.getElementById("name").innerText = "";
    document.getElementById("comment").innerText = "";
    document.getElementById("newBtn").style.display = "none";

    startCircleAnimation();

    raffleInterval = setInterval(()=>{
        let r = comments[Math.floor(Math.random()*comments.length)];
        document.getElementById("name").innerText = "@" + r.author.replace(/^@/, "");
        document.getElementById("comment").innerText = r.comment;
    },55);

    setTimeout(()=>{
        clearInterval(raffleInterval);
        pickWinner();
    },10000);
}

function pickWinner(){
    raffleRunning = false;

    let available = comments.filter(c => !usedWinners.includes(c.author));

    if(available.length === 0){
        alert("No more unique winners left!");
        return;
    }

    let winner = available[Math.floor(Math.random()*available.length)];
    usedWinners.push(winner.author);

    document.getElementById("trophy").style.display = "none";
    const img = document.getElementById("winnerPic");
    img.src = winner.profileImageUrl;
    img.style.display = "block";

    document.getElementById("name").innerText = "@" + winner.author.replace(/^@/, "");
    document.getElementById("comment").innerText = winner.comment;

    document.getElementById("newBtn").style.display = "block";
}

/* BUTTON CONTROLS */
document.getElementById("startBtn").onclick = () => startRaffle();
document.getElementById("newBtn").onclick = () => startRaffle();

</script>
</body>
</html>
