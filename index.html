<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Random Picker ‚Äî Final</title>
<style>
  :root{
    --bg1:#0b6aa6;
    --bg2:#063b5e;
    --accent:#0078ff;
    --card:#ffffff;
    --card-text:#07304f;
    --muted:#6fa7d4;
    --glass: rgba(255,255,255,0.06);
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px;color:#fff}
  .wrap{width:100%;max-width:980px;display:grid;grid-template-columns:1fr 420px;gap:22px}
  .panel{
    background:var(--glass);
    border-radius:var(--radius);
    padding:20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.03);
  }
  h1{margin:0;font-size:20px;font-weight:800;color:#e8f8ff}
  .hint{color:rgba(255,255,255,0.85);font-size:13px;margin-top:8px}
  label{display:block;color:#e6f6ff;font-weight:700;margin-top:14px;font-size:13px}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:none;font-size:15px;margin-top:8px;background:#f6fbff;color:var(--card-text)}
  .checkbox{display:flex;align-items:center;gap:8px;margin-top:8px;color:#dff1ff}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),#0051d9);color:#fff;font-weight:800;cursor:pointer;margin-top:12px;box-shadow:0 10px 24px rgba(0,110,255,0.16)}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#eaf7ff}
  .status{display:none;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#0f6ea8,#0b5da0);font-weight:700;text-align:center}
  /* result card */
  .card{background:var(--card);color:var(--card-text);border-radius:18px;padding:18px;box-shadow:0 14px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;min-height:420px}
  .trophy{width:66px;height:66px;border-radius:16px;background:linear-gradient(180deg,#ffd66f,#ffb347);display:flex;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 8px 18px rgba(255,160,60,0.15);font-size:26px}
  .winnerPic{width:84px;height:84px;border-radius:999px;overflow:hidden;margin:6px auto;display:none;border:3px solid #fff;box-shadow:0 8px 18px rgba(0,0,0,0.12)}
  .winnerPic img{width:100%;height:100%;object-fit:cover;display:block}
  .winnerName{text-align:center;font-weight:800;font-size:20px;color:var(--card-text)}
  .winnerName a{text-decoration:none;color:var(--card-text)}
  .winnerComment{display:none;background:#f7fbff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);color:var(--card-text);font-size:14px}
  .details{background:#f3f8ff;border-radius:10px;padding:10px;border:1px solid rgba(0,0,0,0.06);color:var(--card-text)}
  .drow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.04)}
  .drow:last-child{border-bottom:none}
  .randomFlash{background:#eaf6ff;color:#03314a;padding:10px;border-radius:8px;text-align:center;margin-top:8px}
  .actions{display:flex;gap:12px;justify-content:center;margin-top:auto}
  .primary{background:linear-gradient(180deg,#006aff,#0051d9);color:#fff;padding:12px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .neutral{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:12px 14px;border-radius:10px;color:var(--card-text);cursor:pointer;font-weight:700}
  @media (max-width:900px){.wrap{grid-template-columns:1fr;gap:14px;padding:14px}.card{min-height:380px}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Controls -->
    <div class="panel">
      <h1>YouTube Comment Picker</h1>
      <div class="hint">Paste a YouTube link (watch / shorts / youtu.be). The tool will load comments and pick a winner.</div>

      <label for="videoLink">Paste YouTube link</label>
      <input id="videoLink" type="text" placeholder="https://youtu.be/egH5hKD913Y?si=..." />

      <div class="checkbox">
        <input id="filterDup" type="checkbox" checked />
        <label for="filterDup" style="margin:0;font-weight:600;color:#dff4ff">Filter duplicate users (keep one comment per channel)</label>
      </div>

      <button id="loadBtn" class="btn" onclick="loadComments()">Load All Comments</button>
      <button id="clearBtn" class="btn secondary" onclick="clearAll()">Clear</button>

      <div id="statusBox" class="status">...</div>

      <button id="pickBtn" class="btn" style="display:none;margin-top:12px" onclick="pickWinner()">Pick Winner</button>
    </div>

    <!-- RIGHT: Result / winner -->
    <div class="card">
      <div class="trophy">üèÜ</div>

      <div class="winnerPic" id="winnerPic"><img id="winnerImg" src="" alt="profile"></div>

      <div class="winnerName" id="winnerName">‚Äî</div>

      <div class="winnerComment" id="winnerComment">"</div>

      <div class="details" id="details" style="display:none">
        <div class="drow"><div>Entries</div><div id="entries">0</div></div>
        <div class="drow"><div>Date</div><div id="date">‚Äî</div></div>
        <div class="drow"><div>Video</div><div><a id="videoLinkOut" href="#" target="_blank">Open</a></div></div>
      </div>

      <div id="flashArea"></div>

      <div class="actions">
        <button id="newBtn" class="neutral" onclick="resetAfterPick()" style="display:none">Pick New Winner</button>
      </div>
    </div>
  </div>

<script>
/* ---------------- CONFIG ---------------- */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbw7PfgB2zlGz0Vww58lAH93dtkM4afeW8Ra1vZegd2qu0cY8T7eVtBFbbvv5TAy1GFl/exec";

/* Local state */
let secretPool = [];   // backend-provided pool (secret priority or fallback)
let lastTotals = { totalComments:0, uniqueUsers:0 };
let currentVideoId = "";

/* ------------ helpers ------------ */
function extractVideoId(link){
  try{
    const u = new URL(link);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    if(u.hostname === 'youtu.be') return u.pathname.replace('/','').split('?')[0];
    if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2];
  }catch(e){}
  return null;
}
function show(el){ el.style.display = 'block'; }
function hide(el){ el.style.display = 'none'; }

/* ------------- Load Comments ------------- */
async function loadComments(){
  const box = document.getElementById('statusBox');
  const link = document.getElementById('videoLink').value.trim();
  const vid = extractVideoId(link);
  const pickBtn = document.getElementById('pickBtn');

  // reset UI
  hide(document.getElementById('winnerPic'));
  document.getElementById('winnerName').textContent = '‚Äî';
  hide(document.getElementById('winnerComment'));
  hide(document.getElementById('details'));
  hide(document.getElementById('newBtn'));
  document.getElementById('flashArea').innerHTML = '';

  if(!vid){
    box.style.display='block';
    box.textContent = '‚ùå Invalid YouTube URL';
    return;
  }

  currentVideoId = vid;
  box.style.display='block';
  box.textContent = '‚è≥ Loading comments ‚Äî please wait...';
  pickBtn.style.display = 'none';

  try{
    const resp = await fetch(`${BACKEND_URL}?videoId=${encodeURIComponent(vid)}`);
    const data = await resp.json();

    if(data.error){
      // handle API-level error message
      box.textContent = '‚ùå Backend error: ' + (data.error.message || JSON.stringify(data.error));
      return;
    }

    // Show real totals (always show the real total values returned by backend)
    lastTotals.totalComments = data.totalComments || (data.comments && data.comments.length) || 0;
    lastTotals.uniqueUsers = data.uniqueUsers || 0;
    box.innerHTML = `‚úÖ Loaded <strong>${lastTotals.totalComments}</strong> comments<br>üéØ Unique users: <strong>${lastTotals.uniqueUsers}</strong>`;

    // secret pool (backend decides priority; front-end only receives pool)
    secretPool = data.pool || [];

    // update details
    document.getElementById('entries').textContent = lastTotals.uniqueUsers;
    document.getElementById('date').textContent = new Date().toLocaleString();
    const vlink = `https://youtube.com/watch?v=${vid}`;
    document.getElementById('videoLinkOut').href = vlink;
    document.getElementById('details').style.display = 'block';

    // show pick button
    if(secretPool.length > 0){
      pickBtn.style.display = 'block';
    } else {
      // no commenters at all (rare) ‚Äî show message and hide pick button
      box.textContent = '‚ö†Ô∏è No comments available to pick from.';
      pickBtn.style.display = 'none';
    }

  }catch(err){
    console.error(err);
    box.style.display='block';
    box.textContent = '‚ùå Error fetching comments. (' + (err.message || err) + ')';
  }
}

/* ------------- Pick Winner (uses secretPool) ------------- */
function pickWinner(){
  if(!secretPool || secretPool.length === 0){
    alert('No comments available to pick from.');
    return;
  }

  const flashArea = document.getElementById('flashArea');
  const pickBtn = document.getElementById('pickBtn');
  const newBtn = document.getElementById('newBtn');

  pickBtn.style.display = 'none';
  flashArea.innerHTML = '';

  let rounds = 28;
  let i = 0;
  const interval = setInterval(() => {
    const random = secretPool[Math.floor(Math.random() * secretPool.length)];
    flashArea.innerHTML = `<div class="randomFlash">${random.author}</div>`;
    i++;
    if(i >= rounds){
      clearInterval(interval);
      const final = secretPool[Math.floor(Math.random() * secretPool.length)];

      // Display winner
      const winnerNameEl = document.getElementById('winnerName');
      winnerNameEl.innerHTML = `<a href="https://youtube.com/channel/${final.channelId}" target="_blank">@${final.author}</a>`;

      if(final.comment){
        const wc = document.getElementById('winnerComment');
        wc.style.display = 'block';
        wc.textContent = final.comment;
      } else {
        hide(document.getElementById('winnerComment'));
      }

      if(final.profileImageUrl){
        document.getElementById('winnerImg').src = final.profileImageUrl;
        show(document.getElementById('winnerPic'));
      } else {
        hide(document.getElementById('winnerPic'));
      }

      newBtn.style.display = 'inline-block';
      flashArea.innerHTML = '';
    }
  }, 90);
}

/* ------------- Reset after pick ------------- */
function resetAfterPick(){
  document.getElementById('winnerName').textContent = '‚Äî';
  document.getElementById('winnerComment').textContent = '';
  hide(document.getElementById('winnerComment'));
  hide(document.getElementById('winnerPic'));
  document.getElementById('flashArea').innerHTML = '';
  document.getElementById('newBtn').style.display = 'none';
  document.getElementById('pickBtn').style.display = 'block';
}

/* ------------- Clear all ------------- */
function clearAll(){
  document.getElementById('videoLink').value = '';
  document.getElementById('statusBox').style.display = 'none';
  secretPool = [];
  lastTotals = { totalComments:0, uniqueUsers:0 };
  document.getElementById('winnerName').textContent = '‚Äî';
  document.getElementById('winnerComment').style.display = 'none';
  hide(document.getElementById('winnerPic'));
  hide(document.getElementById('details'));
  document.getElementById('flashArea').innerHTML = '';
  document.getElementById('pickBtn').style.display = 'none';
  document.getElementById('newBtn').style.display = 'none';
}
</script>
</body>
</html>
