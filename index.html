<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Random Comment Picker — Pick Giveaway Winner</title>
<style>
:root{
  --brand:#0E6BB8;      /* deep professional blue */
  --bg: #0E6BB8;
  --white: #ffffff;
  --muted: rgba(255,255,255,0.85);
  --card-radius:18px;
  --shadow: 0 16px 40px rgba(3,25,40,0.12);
  --glass: rgba(255,255,255,0.06);
  --text-dark: #0b2b3d;
  --accent: #0658a8;
}

/* Page */
html,body{
  height:100%;
  margin:0;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: var(--bg);
  color: var(--white);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Layout */
.page {
  max-width: 980px;
  margin: 36px auto;
  padding: 18px;
  box-sizing: border-box;
}

/* Big heading */
.header {
  text-align:center;
  margin-bottom:28px;
}
.h-title {
  font-size:44px;
  font-weight:800;
  margin:0;
  letter-spacing:1px;
  color:var(--white);
}
.h-sub {
  font-size:20px;
  margin:8px 0 0 0;
  color:var(--muted);
  font-weight:700;
}

/* Input card */
.inputCard{
  background:var(--white);
  color:var(--text-dark);
  border-radius:var(--card-radius);
  padding:22px;
  box-shadow:var(--shadow);
}
.label{font-weight:800;color:var(--text-dark);margin-bottom:8px}
.input{
  width:100%;
  box-sizing:border-box;
  padding:14px 16px;
  border-radius:999px;
  border:1px solid #e6f0fb;
  font-size:16px;
  outline:none;
}
.row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
.checkbox {
  display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;
  font-weight:800; color:var(--text-dark);
}
.small{font-size:13px;color:#4b83b6;margin-top:8px}

/* collapsible filter area */
.collapseBox{
  margin-top:10px;
  display:none;
}
.collapseBox .input{
  border-radius:12px;
  padding:10px 12px;
  border:1px solid #e6f0fb;
}

/* Load button & count */
.controls {
  margin-top:14px;
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}
.loadBtn{
  background:var(--white);
  color:var(--text-dark);
  border-radius:999px;
  padding:14px 20px;
  font-weight:900;
  border:none;
  cursor:pointer;
  box-shadow:0 12px 28px rgba(11,43,61,0.08);
  font-size:16px;
}
.countPill{
  display:none;
  background:rgba(255,255,255,0.95);
  color:var(--text-dark);
  padding:10px 16px;
  border-radius:999px;
  font-weight:800;
}

/* Stage card (single white card that stays static) */
.stageCard{
  margin-top:26px;
  width:100%;
  background:var(--white);
  color:var(--text-dark);
  padding:28px;
  border-radius:22px;
  box-shadow:var(--shadow);
  box-sizing:border-box;
  min-height:420px;            /* fixed - avoids layout shift */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:14px;
}
.hintTiny { font-size:12px;color:#597fb0;margin-top:6px; }

/* avatar */
.avatar{
  width:116px;height:116px;border-radius:999px;overflow:hidden;border:6px solid var(--brand);
  display:flex;align-items:center;justify-content:center;background:#fff;
}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}

/* handle & comment */
.handle{font-weight:900;font-size:20px;color:var(--brand)}
.handle a{color:var(--brand);text-decoration:none}
.commentBox{
  background:#f7fbff;color:#114b63;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);width:84%;min-height:54px;max-height:140px;overflow:auto;
  box-shadow:0 8px 20px rgba(3,48,80,0.04);
}

/* start circle */
.startWrapper{margin-top:16px}
.startCircle{
  width:150px;height:150px;border-radius:999px;border:10px solid var(--brand);background:var(--white);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--text-dark);cursor:pointer;box-shadow:0 20px 40px rgba(3,48,80,0.12)
}
.startSmall{font-size:13px;color:#6b95c1;margin-top:8px}

/* pick another & share */
.pickAgain{
  margin-top:18px;
  display:none;
  width:100%;
  background:var(--brand);
  color:#fff;
  border:none;padding:12px;border-radius:12px;font-weight:900;cursor:pointer;
  box-shadow:0 12px 28px rgba(3,25,40,0.12);
}
.shareRow{display:none;gap:10px;margin-top:8px;align-items:center}

/* responsive tweaks */
@media (max-width:720px){
  .h-title{font-size:36px}
  .stageCard{min-height:360px;padding:18px}
  .startCircle{width:120px;height:120px;border-width:8px}
  .avatar{width:96px;height:96px}
}
</style>
</head>
<body>
  <div class="page">

    <!-- HEADER -->
    <div class="header">
      <div class="h-title">YOUTUBE RANDOM COMMENT PICKER</div>
      <div class="h-sub">PICK GIVEAWAY WINNER</div>
    </div>

    <!-- INPUT CARD -->
    <div class="inputCard" role="region" aria-label="Input card">
      <div class="label">VIDEO LINK BELOW</div>
      <input id="videoLink" class="input" placeholder="https://youtu.be/..." aria-label="YouTube link"/>

      <div class="row" style="margin-top:12px;">
        <label class="checkbox" id="dupLabel">
          <input id="filterDup" type="checkbox" checked /> <span>FILTER DUPLICATE AND BOT COMMENTS</span>
        </label>
      </div>

      <div class="row" style="margin-top:10px; align-items:flex-start;">
        <label class="checkbox" id="hashLabel">
          <input id="useFilterWords" type="checkbox" /> <span>FILTER COMMENTS BY WORD OR HASHTAG</span>
        </label>
      </div>

      <div id="collapseBox" class="collapseBox">
        <div class="label">ADD A SPECIAL HASHTAG OR WORD</div>
        <input id="filterWords" class="input" placeholder="e.g. giveaway,#win,subscribe" aria-label="Filter words"/>
        <div class="small">Enter comma-separated words/hashtags. Comments containing any will be loaded.</div>
      </div>

      <div class="controls">
        <button id="loadBtn" class="loadBtn">LOAD ALL UNIQUE COMMENTS</button>
        <div id="countPill" class="countPill" aria-live="polite"></div>
      </div>
    </div>

    <!-- STAGE CARD (static size) -->
    <div id="stageCard" class="stageCard" style="display:none;">
      <div class="small" style="align-self:flex-start;color:#4b83b6">CLICK START TO PICK A WINNER</div>

      <div class="avatar" id="avatarWrap" style="display:none;"><img id="avatarImg" src="" alt="Profile picture"></div>
      <div id="handle" class="handle">—</div>

      <div id="commentBox" class="commentBox">Winner comment will appear here after pick.</div>

      <div class="startWrapper">
        <div id="startCircle" class="startCircle" role="button" tabindex="0">START</div>
        <div class="startSmall">Click to begin shuffle and choose the winner</div>
      </div>

      <button id="pickAgain" class="pickAgain">PICK A NEW WINNER</button>

      <div id="shareRow" class="shareRow">
        <button id="shareBtn" class="loadBtn" style="background:var(--brand);color:#fff;">COPY WINNER LINK</button>
        <div id="shareMsg" style="font-weight:800;color:#0b2b3d"></div>
      </div>
    </div>

  </div>

  <!-- confetti area -->
  <div id="confetti" style="position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:9999"></div>

<script>
/* --------- CONFIG --------- */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzS2QT2vSJ_RoXiQACij7iUWcmcJqFBHEelNrC7h1-XfRcdOx1gdQ1ZvJQuNruRRXM9xA/exec";

/* --------- STATE --------- */
let visibleComments = [];      // used to visually shuffle; excludes persistently used winners
let pickPool = [];             // eligible pool returned by backend (already excludes persisted winners)
let usedThisSession = new Set();
let currentVideoId = "";
let animating = false;

/* --------- DOM --------- */
const videoLinkEl = document.getElementById('videoLink');
const loadBtn = document.getElementById('loadBtn');
const countPill = document.getElementById('countPill');
const collapseBox = document.getElementById('collapseBox');
const useFilterWords = document.getElementById('useFilterWords');
const filterWordsEl = document.getElementById('filterWords');

const stageCard = document.getElementById('stageCard');
const avatarWrap = document.getElementById('avatarWrap');
const avatarImg = document.getElementById('avatarImg');
const handleEl = document.getElementById('handle');
const commentBox = document.getElementById('commentBox');
const startCircle = document.getElementById('startCircle');
const pickAgainBtn = document.getElementById('pickAgain');
const shareRow = document.getElementById('shareRow');
const shareBtn = document.getElementById('shareBtn');
const shareMsg = document.getElementById('shareMsg');
const confettiEl = document.getElementById('confetti');
const filterDupEl = document.getElementById('filterDup');

/* --------- Helpers --------- */
function extractVideoId(link){
  try{
    const u = new URL(link);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    if(u.hostname === 'youtu.be') return u.pathname.replace('/','').split('?')[0];
    if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2];
  }catch(e){}
  return null;
}
function showCount(text){ countPill.style.display='inline-block'; countPill.innerHTML = text; }
function hideCount(){ countPill.style.display='none'; }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* collapse filter words UI */
useFilterWords.addEventListener('change', ()=> {
  collapseBox.style.display = useFilterWords.checked ? 'block' : 'none';
});

/* --------- Load comments (GET) --------- */
loadBtn.addEventListener('click', async ()=> {
  const link = videoLinkEl.value.trim();
  const vid = extractVideoId(link);
  if(!vid){ showCount('❌ Invalid YouTube URL'); return; }
  currentVideoId = vid;

  // reset UI / state
  visibleComments = []; pickPool = []; usedThisSession = new Set();
  avatarWrap.style.display = 'none';
  handleEl.textContent = '—'; commentBox.textContent = '';
  pickAgainBtn.style.display = 'none'; shareRow.style.display = 'none';

  showCount('⏳ Loading comments...');
  loadBtn.disabled = true;

  const filterDup = filterDupEl.checked ? 'true' : 'false';
  const filterWords = encodeURIComponent((filterWordsEl.value || '').trim());

  try {
    const url = `${BACKEND_URL}?videoId=${encodeURIComponent(vid)}&filterDup=${filterDup}&filterWords=${filterWords}`;
    const res = await fetch(url, { method: 'GET' });
    const data = await res.json();

    if(data && data.error){
      showCount('❌ Backend error');
      console.error(data.error);
      loadBtn.disabled = false;
      return;
    }

    // data.comments: for visuals; data.pickPool: actual eligible pool (backend excluded persisted winners)
    visibleComments = (data.comments || []).slice();        // copy
    pickPool = (data.pickPool || []).slice();

    // backend-provided used winners => mark them used in session
    const usedFromBackend = data.usedWinners || [];
    usedFromBackend.forEach(u => usedThisSession.add(u));

    // remove backend-used from visible list so visuals don't show them
    visibleComments = visibleComments.filter(c => !usedThisSession.has(c.channelId));

    // show counts with a simple animated counting
    const total = data.uniqueUsers || visibleComments.length || 0;
    animateCount(total);

    // reveal stage (static white card)
    stageCard.style.display = 'flex';
    loadBtn.disabled = false;
    showCount(`✅ Loaded ${total} unique`);
  } catch(err) {
    console.error(err);
    showCount('❌ Error fetching comments');
    loadBtn.disabled = false;
  }
});

/* small counting animation */
function animateCount(target){
  countPill.style.display = 'inline-block';
  let cur = 0;
  const steps = Math.min(40, Math.max(6, Math.floor(target/2)));
  const increment = Math.max(1, Math.floor(target / steps));
  const delay = Math.max(10, Math.floor(800 / steps));
  const timer = setInterval(()=>{
    cur += increment;
    if(cur >= target) cur = target;
    countPill.innerHTML = `Amount of comments: <strong>${cur}</strong>`;
    if(cur >= target) clearInterval(timer);
  }, delay);
}

/* --------- Visible shuffle (starts when Start clicked) --------- */
startCircle.addEventListener('click', ()=> {
  if(animating) return;
  if(!visibleComments || visibleComments.length === 0){
    showCount('No comments loaded');
    return;
  }

  // hide start while shuffling
  startCircle.style.display = 'none';
  pickAgainBtn.style.display = 'none';
  shareRow.style.display = 'none';
  avatarWrap.style.display = 'block';
  animating = true;

  // local array for visual randomness - includes many users so shuffle looks natural
  const local = visibleComments.slice();
  shuffleArray(local);

  let steps = 56;
  let i = 0;
  let delay = 70;

  function tick(){
    if(!local.length) return;
    const c = local[Math.floor(Math.random()*local.length)];
    avatarImg.src = c.profileImageUrl || '';
    handleEl.textContent = '@' + (c.author || 'unknown');
    commentBox.textContent = c.comment || '';

    i++;
    if(i < steps){
      if(i > steps * 0.6) delay += 18; // slow down near end
      setTimeout(tick, delay);
    } else {
      animating = false;
      finalizePick(); // choose final winner from pickPool (backend-aware)
    }
  }
  tick();
});

/* --------- Final pick and persist winner --------- */
async function finalizePick(){
  try {
    // refresh pickPool from backend to ensure persistent used winners removed
    await refreshPickPool();

    // exclude any usedThisSession entries from pickPool
    pickPool = (pickPool || []).filter(p => {
      const id = p.channelId || (p.author || '').toLowerCase();
      return !usedThisSession.has(id);
    });

    // fallback if pickPool empty: choose from visible comments that are not used in session
    if(!pickPool || pickPool.length === 0){
      const fallback = visibleComments.filter(c => !usedThisSession.has(c.channelId));
      if(fallback.length === 0){
        showCount('No unique candidates left');
        startCircle.style.display = 'block';
        return;
      }
      pickPool = fallback;
    }

    // pick random final
    const final = pickPool[Math.floor(Math.random() * pickPool.length)];

    // display winner details in same card
    avatarImg.src = final.profileImageUrl || '';
    if(final.channelId){
      handleEl.innerHTML = `<a href="https://www.youtube.com/channel/${final.channelId}" target="_blank">@${final.author}</a>`;
    } else {
      handleEl.textContent = '@' + final.author;
    }
    commentBox.textContent = final.comment || '';

    // mark used locally and remove from visibleComments so it won't reappear visually
    const key = final.channelId || (final.author || '').toLowerCase();
    usedThisSession.add(key);
    visibleComments = visibleComments.filter(c => (c.channelId || c.author.toLowerCase()) !== key);

    // persist to backend (markWinner)
    try{
      await fetch(BACKEND_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action: 'markWinner', videoId: currentVideoId, channelId: final.channelId || final.author })
      });
    }catch(e){
      console.warn('markWinner failed', e);
    }

    // show pick again & share
    pickAgainBtn.style.display = 'block';
    shareRow.style.display = 'flex';
    launchConfetti();

    // setup share copy
    const shareUrl = window.location.origin + window.location.pathname + `?videoId=${encodeURIComponent(currentVideoId)}&winner=${encodeURIComponent(final.channelId || final.author)}`;
    shareBtn.onclick = ()=>{
      if(navigator.clipboard) navigator.clipboard.writeText(shareUrl);
      shareMsg.textContent = 'Link copied';
      setTimeout(()=> shareMsg.textContent = '', 2200);
    };

  } catch(err){
    console.error(err);
    showCount('Error selecting winner');
    startCircle.style.display = 'block';
  }
}

/* --------- Pick another winner (no reload) --------- */
pickAgainBtn.addEventListener('click', async ()=>{
  // disable button while preparing
  pickAgainBtn.style.display = 'none';
  shareRow.style.display = 'none';

  // refresh pool and start visual shuffle again to pick next winner
  await refreshPickPool();

  if(!visibleComments || visibleComments.length === 0){
    showCount('No remaining candidates');
    return;
  }

  // visual shuffle (shorter)
  animating = true;
  let steps = 42;
  let i = 0; let delay = 66;
  const local = visibleComments.slice();
  shuffleArray(local);

  function tickAgain(){
    const c = local[Math.floor(Math.random()*local.length)];
    avatarImg.src = c.profileImageUrl || '';
    handleEl.textContent = '@' + (c.author || 'unknown');
    commentBox.textContent = c.comment || '';
    i++;
    if(i < steps){
      if(i > steps * 0.6) delay += 16;
      setTimeout(tickAgain, delay);
    } else {
      animating = false;
      finalizePick();
    }
  }
  tickAgain();
});

/* --------- Refresh pickPool from backend --------- */
async function refreshPickPool(){
  try{
    const filterDup = filterDupEl.checked ? 'true' : 'false';
    const filterWords = encodeURIComponent((filterWordsEl.value || '').trim());
    const url = `${BACKEND_URL}?videoId=${encodeURIComponent(currentVideoId)}&filterDup=${filterDup}&filterWords=${filterWords}`;
    const res = await fetch(url);
    const data = await res.json();
    pickPool = data.pickPool || [];
    // mark backend used in session and remove them from visibleComments
    const usedFromBackend = data.usedWinners || [];
    usedFromBackend.forEach(u => usedThisSession.add(u));
    visibleComments = visibleComments.filter(c => !usedFromBackend.includes(c.channelId));
    // also remove any usedThisSession entries from pickPool
    pickPool = pickPool.filter(p => !usedThisSession.has(p.channelId || p.author.toLowerCase()));
  }catch(e){
    console.warn('refreshPickPool failed', e);
  }
}

/* --------- Confetti effect --------- */
function launchConfetti(){
  const colors = ['#ffd66f','#ff9fa2','#9ef0b1','#9ed8ff','#d09eff','#ffd7a6'];
  for(let i=0;i<28;i++){
    const el = document.createElement('div');
    el.style.position = 'absolute';
    el.style.width = (6 + Math.random()*8) + 'px';
    el.style.height = (10 + Math.random()*14) + 'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.left = (40 + Math.random()*20) + '%';
    el.style.top = '10%';
    el.style.borderRadius = '2px';
    el.style.opacity = '0.98';
    confettiEl.appendChild(el);
    const dx = (Math.random()-0.5)*600;
    const dy = 250 + Math.random()*500;
    el.animate(
      [
        { transform: 'translate(0,0) rotate(0deg)', opacity:1 },
        { transform: `translate(${dx}px, ${dy}px) rotate(${Math.random()*720}deg)`, opacity:0.9 }
      ],
      { duration: 900 + Math.random()*900, easing: 'cubic-bezier(.2,.8,.2,1)' }
    );
    setTimeout(()=> el.remove(), 1500 + Math.random()*900);
  }
}

/* --------- Support: show winner if link has winner param --------- */
(async function showFromQuery(){
  const q = new URLSearchParams(location.search);
  const vid = q.get('videoId');
  const winner = q.get('winner');
  if(vid && winner){
    videoLinkEl.value = 'https://www.youtube.com/watch?v=' + vid;
    // auto-load (simulate click)
    await new Promise(r => setTimeout(r, 300));
    document.getElementById('loadBtn').click();
    // wait for data then display winner if exists
    const poll = setInterval(()=>{
      if(stageCard.style.display === 'flex'){
        clearInterval(poll);
        // attempt to find winner in visible or pickPool via refresh
        refreshPickPool().then(()=> {
          const all = (pickPool || []).concat(visibleComments || []);
          const found = all.find(x => (x.channelId == winner) || (x.author && x.author.toLowerCase() == winner.toLowerCase()));
          if(found){
            avatarWrap.style.display = 'block';
            avatarImg.src = found.profileImageUrl || '';
            if(found.channelId) handleEl.innerHTML = `<a href="https://www.youtube.com/channel/${found.channelId}" target="_blank">@${found.author}</a>`;
            else handleEl.textContent = '@' + found.author;
            commentBox.textContent = found.comment || '';
            pickAgainBtn.style.display='block';
            shareRow.style.display='flex';
          }
        });
      }
    }, 700);
  }
})();

</script>
</body>
</html>
